<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Services - Admin | Barangay 118</title>
    <link rel="shortcut icon" type="image/png" href="Logo-Favicon-removebg-preview.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="AboutUsAdmin.css">
    <style>
        /* Additional Emergency-specific styles */
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .type-critical { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; }
        .type-urgent { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .type-important { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        .type-normal { background: linear-gradient(135deg, #64748b, #475569); color: white; }
        
        .icon-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .icon-option {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .icon-option:hover {
            border-color: var(--primary);
            background: var(--gray-light);
        }
        
        .icon-option.selected {
            border-color: var(--primary);
            background: var(--primary-soft);
            color: var(--primary);
        }
        
        .step-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .step-input {
            flex: 1;
        }
        
        .step-actions {
            display: flex;
            gap: 5px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .category-checkbox {
            width: 18px;
            height: 18px;
        }
        
        .category-input {
            flex: 1;
        }
        
        .accordion-preview {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .accordion-preview-header {
            padding: 15px;
            background: var(--primary-soft);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .accordion-preview-content {
            padding: 15px;
            background: var(--gray-light);
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="container">
            <div class="navbar">
                <div class="logo" onclick="window.open('Emergency.html', '_blank')">
                    <div class="logo-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <h1>BARANGAY 118 ONLINE SYSTEM - EMERGENCY ADMIN</h1>
                </div>

                <div class="nav-links">
                    <a href="PanelAdminView.html">Home</a>
                    <a href="AboutUsAdmin.html">About</a>
                    <a href="NewsAdmin.html">News</a>
                    <a href="EmergencyAdmin.html" class="active">Emergency</a>
                    <a href="CreateAccountAdmin.html">Create</a>
                    <a href="LogAdminControl.html">LogIn</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Panel -->
    <div class="admin-panel">
        <!-- Left Sidebar - Control Center -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title"><i class="fas fa-cogs"></i> Control Center</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-tab="welcome"><span class="sidebar-icon"><i class="fas fa-home"></i></span> Dashboard</a></li>
                <li><a href="#" data-tab="hero"><span class="sidebar-icon"><i class="fas fa-heading"></i></span> Hero Section</a></li>
                <li><a href="#" data-tab="quickcall"><span class="sidebar-icon"><i class="fas fa-phone-alt"></i></span> Quick Call</a></li>
                <li><a href="#" data-tab="contacts"><span class="sidebar-icon"><i class="fas fa-address-book"></i></span> Contacts</a></li>
                <li><a href="#" data-tab="procedures"><span class="sidebar-icon"><i class="fas fa-list-check"></i></span> Procedures</a></li>
                <li><a href="#" data-tab="facilities"><span class="sidebar-icon"><i class="fas fa-map-marker-alt"></i></span> Facilities</a></li>
                <li><a href="#" data-tab="preparation"><span class="sidebar-icon"><i class="fas fa-kit-medical"></i></span> Preparation</a></li>
                <li><a href="#" data-tab="footer"><span class="sidebar-icon"><i class="fas fa-shoe-prints"></i></span> Footer</a></li>
            </ul>

            <!-- ADDED LOGOUT BUTTON AT BOTTOM OF SIDEBAR -->
            <div class="sidebar-footer">
                <a href="LogIn.html" class="sidebar-logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <div class="admin-content">
            <!-- Dashboard Tab -->
            <div id="welcome" class="tab-content active">
                <div class="admin-section">
                    <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Emergency Dashboard</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="system-status">Ready</div>
                            <div class="stat-label">System Status</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-contacts">0</div>
                            <div class="stat-label">Total Contacts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-facilities">0</div>
                            <div class="stat-label">Emergency Facilities</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="data-size">0 KB</div>
                            <div class="stat-label">Data Size</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong><i class="fas fa-check-circle"></i> Emergency System Ready!</strong> Welcome to the Barangay 118 Emergency Admin Panel.
                    </div>
                    
                    <h3 style="margin-bottom: 15px; color: var(--dark);">Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="btn btn-primary" id="preview-emergency-btn">
                            <i class="fas fa-external-link-alt"></i> Preview Emergency Page
                        </button>
                        <button class="btn btn-secondary" id="export-emergency-btn">
                            <i class="fas fa-download"></i> Export Emergency Data
                        </button>
                        <button class="btn btn-success" id="backup-emergency-btn">
                            <i class="fas fa-database"></i> Backup Emergency Data
                        </button>
                        <button class="btn btn-warning" id="refresh-emergency-btn">
                            <i class="fas fa-sync"></i> Refresh Data
                        </button>
                        <button class="btn btn-danger" id="clear-emergency-data-btn">
                            <i class="fas fa-trash"></i> Clear All Data
                        </button>
                    </div>
                </div>

                <div class="admin-section">
                    <h2 class="section-title"><i class="fas fa-history"></i> Recent Emergency Activity</h2>
                    <div id="recent-activity">
                        <p style="color: var(--gray); text-align: center; padding: 20px;">
                            <i class="fas fa-clock"></i> Activity log will appear here...
                        </p>
                    </div>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="welcome-guide" class="guide-section">
                        <h4>Emergency Dashboard Overview</h4>
                        <p>The dashboard provides a quick overview of your emergency system's key metrics and recent activity.</p>
                        <ul>
                            <li>Monitor system status and data size</li>
                            <li>Track total emergency contacts and facilities</li>
                            <li>View recent system activity</li>
                            <li>Use quick actions for common tasks</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Hero Section Tab -->
            <div id="hero" class="tab-content">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="fas fa-heading"></i> Hero Section Management</h2>
                        <div class="action-buttons">
                            <a href="Emergency.html" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View Emergency Page
                            </a>
                        </div>
                    </div>
                    
                    <p style="color: var(--gray); margin-bottom: 25px;">Update the main hero section that appears at the top of your Emergency page.</p>
                    
                    <form id="hero-form">
                        <div class="form-group">
                            <label class="form-label" for="hero-title">Hero Title</label>
                            <input type="text" class="form-control" id="hero-title" placeholder="Enter emergency hero title">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="hero-description">Hero Description</label>
                            <textarea class="form-control" id="hero-description" placeholder="Enter emergency hero description"></textarea>
                            <small style="color: var(--gray); margin-top: 5px; display: block;">Brief description that appears below the title</small>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons-container">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Hero Section
                            </button>
                            <button type="button" class="btn btn-warning" id="hero-reset-btn">
                                <i class="fas fa-undo"></i> Reset to Defaults
                            </button>
                        </div>
                    </form>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="hero-guide" class="guide-section">
                        <h4>Hero Section</h4>
                        <p>Customize the main hero section of your Emergency page.</p>
                        <ul>
                            <li>Update the emergency page title</li>
                            <li>Modify the hero description</li>
                            <li>Changes appear immediately on the main site</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Quick Call Tab -->
            <div id="quickcall" class="tab-content">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="fas fa-phone-alt"></i> Quick Call Section</h2>
                        <div class="action-buttons">
                            <a href="Emergency.html" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View Emergency Page
                            </a>
                        </div>
                    </div>
                    
                    <p style="color: var(--gray); margin-bottom: 25px;">Manage emergency contact numbers for the Quick Call section. These are prominently displayed for immediate access.</p>
                    
                    <div class="search-container">
                        <input type="text" class="search-bar" id="quickcall-search" placeholder="Search contacts by title or number...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-quickcall-tab="existing">
                            <i class="fa-solid fa-phone-volume"></i> Existing Contacts
                        </div>
                        <div class="tab" data-quickcall-tab="add">
                            <i class="fa-solid fa-phone-plus"></i> Add New Contact
                        </div>
                        <div class="tab" data-quickcall-tab="section">
                            <i class="fa-solid fa-gear"></i> Section Settings
                        </div>
                    </div>
                    
                    <div id="existing-quickcall" class="tab-content active">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Title</th>
                                    <th>Subtitle</th>
                                    <th>Number</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quickcall-table-body">
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="add-quickcall" class="tab-content">
                        <form id="quickcall-form">
                            <input type="hidden" id="quickcall-edit-id" value="">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="quickcall-title">Title *</label>
                                    <input type="text" class="form-control" id="quickcall-title" placeholder="e.g., Medical Emergency" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="quickcall-subtitle">Subtitle</label>
                                    <input type="text" class="form-control" id="quickcall-subtitle" placeholder="e.g., Ambulance & Medical Assistance">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="quickcall-number">Phone Number *</label>
                                    <input type="text" class="form-control" id="quickcall-number" placeholder="e.g., 911 or (02) 123-4567" required>
                                    <small style="color: var(--gray); margin-top: 5px; display: block;">Include area code if applicable</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="quickcall-type">Contact Type</label>
                                    <select class="form-control" id="quickcall-type">
                                        <option value="critical">Critical (Red)</option>
                                        <option value="urgent">Urgent (Orange)</option>
                                        <option value="important">Important (Blue)</option>
                                        <option value="normal">Normal (Gray)</option>
                                    </select>
                                    <small style="color: var(--gray); margin-top: 5px; display: block;">Determines the card color</small>
                                </div>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-success" id="quickcall-submit-btn">
                                    <i class="fas fa-plus-circle"></i> Add Contact
                                </button>
                                <button type="button" class="btn btn-secondary" id="quickcall-cancel-edit" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Edit
                                </button>
                                <button type="button" class="btn btn-warning" id="quickcall-reset-btn">
                                    <i class="fas fa-undo"></i> Reset All Contacts
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="section-quickcall" class="tab-content">
                        <form id="quickcall-section-form">
                            <div class="form-group">
                                <label class="form-label" for="quickcall-section-title">Section Title</label>
                                <input type="text" class="form-control" id="quickcall-section-title" placeholder="Enter section title">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="quickcall-section-description">Section Description</label>
                                <textarea class="form-control" id="quickcall-section-description" placeholder="Enter section description"></textarea>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Section
                                </button>
                                <button type="button" class="btn btn-warning" id="quickcall-section-reset-btn">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="quickcall-guide" class="guide-section">
                        <h4>Quick Call Management</h4>
                        <p>Manage emergency contact numbers for quick access.</p>
                        <ul>
                            <li>Add, edit, and delete emergency contacts</li>
                            <li>Set contact type for color coding (Critical, Urgent, Important, Normal)</li>
                            <li>Customize section title and description</li>
                            <li>Keep contact information up-to-date</li>
                            <li>Changes appear on the Emergency page</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Contacts Tab -->
            <div id="contacts" class="tab-content">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="fas fa-address-book"></i> Contacts Section</h2>
                        <div class="action-buttons">
                            <a href="Emergency.html" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View Emergency Page
                            </a>
                        </div>
                    </div>
                    
                    <p style="color: var(--gray); margin-bottom: 25px;">Manage detailed emergency contacts organized by category (Medical, Fire, Police, Barangay).</p>
                    
                    <div class="search-container">
                        <input type="text" class="search-bar" id="contacts-search" placeholder="Search contacts by category or title...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-contacts-tab="existing">
                            <i class="fa-solid fa-list"></i> Existing Categories
                        </div>
                        <div class="tab" data-contacts-tab="add">
                            <i class="fa-solid fa-folder-plus"></i> Add New Category
                        </div>
                        <div class="tab" data-contacts-tab="section">
                            <i class="fa-solid fa-gear"></i> Section Settings
                        </div>
                    </div>
                    
                    <div id="existing-contacts" class="tab-content active">
                        <div class="accordion-preview" id="contacts-accordion-preview">
                            <!-- Accordion preview will be generated here -->
                        </div>
                    </div>
                    
                    <div id="add-contacts" class="tab-content">
                        <form id="contacts-form">
                            <input type="hidden" id="contacts-edit-id" value="">
                            <input type="hidden" id="contacts-item-edit-id" value="">
                            
                            <div class="tabs">
                                <div class="tab active" data-contacts-form-tab="category">
                                    Category Details
                                </div>
                                <div class="tab" data-contacts-form-tab="items">
                                    Contact Items
                                </div>
                            </div>
                            
                            <div id="category-contacts-form" class="tab-content active">
                                <div class="form-group">
                                    <label class="form-label" for="contacts-category-title">Category Title *</label>
                                    <input type="text" class="form-control" id="contacts-category-title" placeholder="e.g., Medical Services" required>
                                </div>
                                
                                <div class="action-buttons-container">
                                    <button type="button" class="btn btn-primary" id="save-category-btn">
                                        <i class="fas fa-save"></i> Save Category
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="next-to-items-btn">
                                        <i class="fas fa-arrow-right"></i> Next: Add Contact Items
                                    </button>
                                </div>
                            </div>
                            
                            <div id="items-contacts-form" class="tab-content">
                                <h4>Contact Items for: <span id="current-category-title"></span></h4>
                                <div id="contact-items-list">
                                    <!-- Contact items will be added here -->
                                </div>
                                
                                <div class="form-group">
                                    <button type="button" class="btn btn-success btn-sm" id="add-contact-item-btn">
                                        <i class="fas fa-plus"></i> Add Contact Item
                                    </button>
                                </div>
                                
                                <div class="action-buttons-container">
                                    <button type="submit" class="btn btn-primary" id="save-contacts-btn">
                                        <i class="fas fa-save"></i> Save All Contacts
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="back-to-category-btn">
                                        <i class="fas fa-arrow-left"></i> Back to Category
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div id="section-contacts" class="tab-content">
                        <form id="contacts-section-form">
                            <div class="form-group">
                                <label class="form-label" for="contacts-section-title">Section Title</label>
                                <input type="text" class="form-control" id="contacts-section-title" placeholder="Enter section title">
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Section
                                </button>
                                <button type="button" class="btn btn-warning" id="contacts-section-reset-btn">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="contacts-guide" class="guide-section">
                        <h4>Contacts Management</h4>
                        <p>Manage detailed emergency contacts organized by category.</p>
                        <ul>
                            <li>Create categories (Medical, Fire, Police, Barangay)</li>
                            <li>Add multiple contact items per category</li>
                            <li>Each contact includes: Title, Number, Description, Hours</li>
                            <li>Preview accordion layout before saving</li>
                            <li>Changes appear on the Emergency page</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Procedures Tab -->
            <div id="procedures" class="tab-content">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="fas fa-list-check"></i> Procedures Section</h2>
                        <div class="action-buttons">
                            <a href="Emergency.html" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View Emergency Page
                            </a>
                        </div>
                    </div>
                    
                    <p style="color: var(--gray); margin-bottom: 25px;">Manage emergency procedures with step-by-step instructions for different scenarios.</p>
                    
                    <div class="search-container">
                        <input type="text" class="search-bar" id="procedures-search" placeholder="Search procedures by title...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-procedures-tab="existing">
                            <i class="fa-solid fa-clipboard-list"></i> Existing Procedures
                        </div>
                        <div class="tab" data-procedures-tab="add">
                            <i class="fa-solid fa-circle-plus"></i> Add New Procedure
                        </div>
                        <div class="tab" data-procedures-tab="section">
                            <i class="fa-solid fa-gear"></i> Section Settings
                        </div>
                    </div>
                    
                    <div id="existing-procedures" class="tab-content active">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Icon</th>
                                    <th>Title</th>
                                    <th>Steps</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="procedures-table-body">
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="add-procedures" class="tab-content">
                        <form id="procedures-form">
                            <input type="hidden" id="procedures-edit-id" value="">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="procedures-title">Procedure Title *</label>
                                    <input type="text" class="form-control" id="procedures-title" placeholder="e.g., Fire Emergency" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="procedures-icon">Icon</label>
                                    <div class="icon-picker">
                                        <div class="icon-option" data-icon="fas fa-fire">üî•</div>
                                        <div class="icon-option" data-icon="fas fa-heartbeat">‚ù§Ô∏è</div>
                                        <div class="icon-option" data-icon="fas fa-house-tsunami">üåä</div>
                                        <div class="icon-option" data-icon="fas fa-cloud-showers-heavy">üåßÔ∏è</div>
                                        <div class="icon-option" data-icon="fas fa-bolt">‚ö°</div>
                                        <div class="icon-option" data-icon="fas fa-triangle-exclamation">‚ö†Ô∏è</div>
                                    </div>
                                    <input type="hidden" id="procedures-icon" value="fas fa-fire">
                                    <small style="color: var(--gray); margin-top: 5px; display: block;">Click to select an icon</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Procedure Steps *</label>
                                <div id="procedure-steps-container">
                                    <!-- Steps will be added here -->
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" id="add-step-btn">
                                    <i class="fas fa-plus"></i> Add Step
                                </button>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-success" id="procedures-submit-btn">
                                    <i class="fas fa-plus-circle"></i> Add Procedure
                                </button>
                                <button type="button" class="btn btn-secondary" id="procedures-cancel-edit" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Edit
                                </button>
                                <button type="button" class="btn btn-warning" id="procedures-reset-btn">
                                    <i class="fas fa-undo"></i> Reset All Procedures
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="section-procedures" class="tab-content">
                        <form id="procedures-section-form">
                            <div class="form-group">
                                <label class="form-label" for="procedures-section-title">Section Title</label>
                                <input type="text" class="form-control" id="procedures-section-title" placeholder="Enter section title">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="procedures-section-description">Section Description</label>
                                <textarea class="form-control" id="procedures-section-description" placeholder="Enter section description"></textarea>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Section
                                </button>
                                <button type="button" class="btn btn-warning" id="procedures-section-reset-btn">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="procedures-guide" class="guide-section">
                        <h4>Procedures Management</h4>
                        <p>Manage emergency procedures with step-by-step instructions.</p>
                        <ul>
                            <li>Add, edit, and delete emergency procedures</li>
                            <li>Select icons for each procedure type</li>
                            <li>Add multiple steps in order</li>
                            <li>Customize section title and description</li>
                            <li>Keep procedures clear and concise</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Facilities Tab -->
            <div id="facilities" class="tab-content">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="fas fa-map-marker-alt"></i> Facilities Section</h2>
                        <div class="action-buttons">
                            <a href="Emergency.html" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View Emergency Page
                            </a>
                        </div>
                    </div>
                    
                    <p style="color: var(--gray); margin-bottom: 25px;">Manage nearest emergency facilities with location details and map links.</p>
                    
                    <div class="search-container">
                        <input type="text" class="search-bar" id="facilities-search" placeholder="Search facilities by name or type...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-facilities-tab="existing">
                            <i class="fa-solid fa-hospital"></i> Existing Facilities
                        </div>
                        <div class="tab" data-facilities-tab="add">
                            <i class="fa-solid fa-location-plus"></i> Add New Facility
                        </div>
                        <div class="tab" data-facilities-tab="section">
                            <i class="fa-solid fa-gear"></i> Section Settings
                        </div>
                    </div>
                    
                    <div id="existing-facilities" class="tab-content active">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Distance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="facilities-table-body">
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="add-facilities" class="tab-content">
                        <form id="facilities-form">
                            <input type="hidden" id="facilities-edit-id" value="">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="facilities-name">Facility Name *</label>
                                    <input type="text" class="form-control" id="facilities-name" placeholder="e.g., Caloocan City Medical Center" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="facilities-type">Facility Type</label>
                                    <select class="form-control" id="facilities-type">
                                        <option value="medical">Medical</option>
                                        <option value="fire">Fire Station</option>
                                        <option value="police">Police Station</option>
                                        <option value="barangay">Barangay Hall</option>
                                        <option value="evacuation">Evacuation Center</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="facilities-address">Address *</label>
                                <textarea class="form-control" id="facilities-address" placeholder="Full address of the facility" required></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="facilities-distance">Distance from Barangay</label>
                                    <input type="text" class="form-control" id="facilities-distance" placeholder="e.g., 1.4 km from Barangay 118">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="facilities-hours">Operating Hours</label>
                                    <input type="text" class="form-control" id="facilities-hours" placeholder="e.g., 24/7 Service">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="facilities-map-link">Google Maps Link *</label>
                                <input type="text" class="form-control" id="facilities-map-link" placeholder="https://maps.app.goo.gl/..." required>
                                <small style="color: var(--gray); margin-top: 5px; display: block;">Copy the "Share" link from Google Maps</small>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-success" id="facilities-submit-btn">
                                    <i class="fas fa-plus-circle"></i> Add Facility
                                </button>
                                <button type="button" class="btn btn-secondary" id="facilities-cancel-edit" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Edit
                                </button>
                                <button type="button" class="btn btn-warning" id="facilities-reset-btn">
                                    <i class="fas fa-undo"></i> Reset All Facilities
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="section-facilities" class="tab-content">
                        <form id="facilities-section-form">
                            <div class="form-group">
                                <label class="form-label" for="facilities-section-title">Section Title</label>
                                <input type="text" class="form-control" id="facilities-section-title" placeholder="Enter section title">
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Section
                                </button>
                                <button type="button" class="btn btn-warning" id="facilities-section-reset-btn">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="facilities-guide" class="guide-section">
                        <h4>Facilities Management</h4>
                        <p>Manage nearest emergency facilities with location details.</p>
                        <ul>
                            <li>Add, edit, and delete emergency facilities</li>
                            <li>Categorize by type (Medical, Fire, Police, Barangay, Evacuation)</li>
                            <li>Include address, distance, and operating hours</li>
                            <li>Add Google Maps link for directions</li>
                            <li>Keep information accurate and up-to-date</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Preparation Tab -->
            <div id="preparation" class="tab-content">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="fas fa-kit-medical"></i> Preparation Section</h2>
                        <div class="action-buttons">
                            <a href="Emergency.html" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View Emergency Page
                            </a>
                        </div>
                    </div>
                    
                    <p style="color: var(--gray); margin-bottom: 25px;">Manage emergency preparedness kit checklist and important tips.</p>
                    
                    <div class="search-container">
                        <input type="text" class="search-bar" id="preparation-search" placeholder="Search categories...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-preparation-tab="existing">
                            <i class="fa-solid fa-clipboard-check"></i> Existing Checklist
                        </div>
                        <div class="tab" data-preparation-tab="add">
                            <i class="fa-solid fa-list-check"></i> Add New Category
                        </div>
                        <div class="tab" data-preparation-tab="tips">
                            <i class="fa-solid fa-lightbulb"></i> Important Tips
                        </div>
                        <div class="tab" data-preparation-tab="section">
                            <i class="fa-solid fa-gear"></i> Section Settings
                        </div>
                    </div>
                    
                    <div id="existing-preparation" class="tab-content active">
                        <div id="preparation-checklist-preview">
                            <!-- Checklist preview will be generated here -->
                        </div>
                    </div>
                    
                    <div id="add-preparation" class="tab-content">
                        <form id="preparation-form">
                            <input type="hidden" id="preparation-edit-id" value="">
                            <div class="form-group">
                                <label class="form-label" for="preparation-category">Category Title *</label>
                                <input type="text" class="form-control" id="preparation-category" placeholder="e.g., Medical & First Aid" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Checklist Items</label>
                                <div id="preparation-items-container">
                                    <!-- Items will be added here -->
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" id="add-checklist-item-btn">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-success" id="preparation-submit-btn">
                                    <i class="fas fa-plus-circle"></i> Add Category
                                </button>
                                <button type="button" class="btn btn-secondary" id="preparation-cancel-edit" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Edit
                                </button>
                                <button type="button" class="btn btn-warning" id="preparation-reset-btn">
                                    <i class="fas fa-undo"></i> Reset All Categories
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="tips-preparation" class="tab-content">
                        <form id="preparation-tips-form">
                            <div class="form-group">
                                <label class="form-label" for="preparation-tips-title">Tips Title</label>
                                <input type="text" class="form-control" id="preparation-tips-title" placeholder="e.g., Important Tips:">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tips List</label>
                                <div id="preparation-tips-container">
                                    <!-- Tips will be added here -->
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" id="add-tip-btn">
                                    <i class="fas fa-plus"></i> Add Tip
                                </button>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Tips
                                </button>
                                <button type="button" class="btn btn-warning" id="preparation-tips-reset-btn">
                                    <i class="fas fa-undo"></i> Reset Tips
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="section-preparation" class="tab-content">
                        <form id="preparation-section-form">
                            <div class="form-group">
                                <label class="form-label" for="preparation-section-title">Section Title</label>
                                <input type="text" class="form-control" id="preparation-section-title" placeholder="Enter section title">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="preparation-section-description">Section Description</label>
                                <textarea class="form-control" id="preparation-section-description" placeholder="Enter section description"></textarea>
                            </div>
                            
                            <div class="action-buttons-container">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Section
                                </button>
                                <button type="button" class="btn btn-warning" id="preparation-section-reset-btn">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="preparation-guide" class="guide-section">
                        <h4>Preparation Management</h4>
                        <p>Manage emergency preparedness kit checklist and tips.</p>
                        <ul>
                            <li>Create checklist categories (Medical, Food, Light, Documents)</li>
                            <li>Add multiple items per category</li>
                            <li>Manage important tips for emergency preparation</li>
                            <li>Customize section title and description</li>
                            <li>Keep information practical and actionable</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Footer Tab -->
            <div id="footer" class="tab-content">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="fas fa-shoe-prints"></i> Footer Section</h2>
                        <div class="action-buttons">
                            <a href="Emergency.html" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-eye"></i> View Emergency Page
                            </a>
                        </div>
                    </div>
                    
                    <p style="color: var(--gray); margin-bottom: 25px;">Update the footer information for the Emergency page.</p>
                    
                    <form id="footer-form">
                        <div class="form-group">
                            <label class="form-label" for="footer-title">Footer Title</label>
                            <input type="text" class="form-control" id="footer-title" placeholder="Enter footer title">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="footer-description">Footer Description</label>
                            <textarea class="form-control" id="footer-description" placeholder="Enter footer description"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="footer-copyright">Copyright Text</label>
                            <input type="text" class="form-control" id="footer-copyright" placeholder="Enter copyright text">
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons-container">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Footer
                            </button>
                            <button type="button" class="btn btn-warning" id="footer-reset-btn">
                                <i class="fas fa-undo"></i> Reset to Defaults
                            </button>
                        </div>
                    </form>
                </div>

                <div class="quick-guide-center">
                    <div class="quick-guide-header">
                        <h2 class="quick-guide-title"><i class="fas fa-book"></i> Quick Guide</h2>
                    </div>
                    
                    <div id="footer-guide" class="guide-section">
                        <h4>Footer Section</h4>
                        <p>Customize the footer of your Emergency page.</p>
                        <ul>
                            <li>Update footer title and description</li>
                            <li>Modify copyright text</li>
                            <li>Changes appear on the Emergency page</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Status Indicator -->
    <div id="save-status" class="save-status">‚Ä¢ Manual Save</div>

    <script>
        // Default emergency data structure matching the user view
        const defaultEmergencyData = {
            hero: {
                title: "Emergency Assistance",
                description: "Quick access to emergency services for Barangay 118 residents"
            },
            quickCall: {
                title: "Emergency Contact Numbers",
                description: "Reference only. Please dial these numbers manually when needed.",
                cards: [
                    { 
                        id: 1, 
                        type: "critical", 
                        title: "Medical Emergency", 
                        subtitle: "Ambulance & Medical Assistance", 
                        number: "911" 
                    },
                    { 
                        id: 2, 
                        type: "urgent", 
                        title: "Fire Emergency", 
                        subtitle: "Fire Department & Rescue", 
                        number: "(02) 8426-0219" 
                    },
                    { 
                        id: 3, 
                        type: "important", 
                        title: "Police Emergency", 
                        subtitle: "Crime & Police Assistance", 
                        number: "117" 
                    },
                    { 
                        id: 4, 
                        type: "normal", 
                        title: "Barangay Hotline", 
                        subtitle: "Local Emergency Assistance", 
                        number: "(02) 8123-4567" 
                    }
                ]
            },
            contacts: {
                title: "Emergency Contacts Directory",
                accordions: [
                    {
                        id: 1,
                        title: "Medical Services",
                        items: [
                            { 
                                id: 1, 
                                title: "Emergency Medical Services", 
                                number: "911", 
                                description: "24/7 ambulance and emergency medical response", 
                                hours: "Available: 24/7" 
                            },
                            { 
                                id: 2, 
                                title: "Caloocan City Medical Center", 
                                number: "(02) 8292-1111", 
                                description: "Nearest public hospital for emergencies", 
                                hours: "Emergency Room: 24/7" 
                            }
                        ]
                    },
                    {
                        id: 2,
                        title: "Fire Department",
                        items: [
                            { 
                                id: 3, 
                                title: "Caloocan Fire Department", 
                                number: "(02) 8426-0219", 
                                description: "Fire emergencies and rescue operations", 
                                hours: "Available: 24/7" 
                            }
                        ]
                    },
                    {
                        id: 3,
                        title: "Police Services",
                        items: [
                            { 
                                id: 4, 
                                title: "Caloocan Police Department", 
                                number: "117 / (02) 83612629", 
                                description: "Police assistance and crime reporting", 
                                hours: "Emergency Hotline: 117 (24/7)" 
                            }
                        ]
                    },
                    {
                        id: 4,
                        title: "Barangay Services",
                        items: [
                            { 
                                id: 5, 
                                title: "Barangay 118 Emergency", 
                                number: "(02) 8123-4567", 
                                description: "Local emergencies and community assistance", 
                                hours: "Office: 8AM‚Äì5PM (Mon‚ÄìFri)<br>Emergency: 24/7" 
                            },
                            { 
                                id: 6, 
                                title: "Barangay 118 Disaster Council", 
                                number: "0999-123-4567", 
                                description: "Disaster response team", 
                                hours: "Mobile: 24/7 during disasters" 
                            }
                        ]
                    }
                ]
            },
            procedures: {
                title: "Emergency Procedures",
                description: "Step-by-step guide for different emergencies",
                cards: [
                    { 
                        id: 1, 
                        icon: "fas fa-fire", 
                        title: "Fire Emergency", 
                        steps: [
                            "Shout \"Fire!\" to alert everyone",
                            "Call 911 or fire department",
                            "Use stairs, not elevators",
                            "Crawl low under smoke"
                        ]
                    },
                    { 
                        id: 2, 
                        icon: "fas fa-heartbeat", 
                        title: "Medical Emergency", 
                        steps: [
                            "Ensure area is safe",
                            "Call 911 immediately",
                            "Provide basic care if trained",
                            "Clear path for responders"
                        ]
                    },
                    { 
                        id: 3, 
                        icon: "fas fa-house-tsunami", 
                        title: "Earthquake", 
                        steps: [
                            "DROP to the ground",
                            "COVER under sturdy furniture",
                            "HOLD ON until shaking stops",
                            "Evacuate if necessary"
                        ]
                    },
                    { 
                        id: 4, 
                        icon: "fas fa-cloud-showers-heavy", 
                        title: "Typhoon/Flood", 
                        steps: [
                            "Stay updated on warnings",
                            "Move to higher ground if flooding",
                            "Avoid flood waters",
                            "Have emergency kit ready"
                        ]
                    }
                ]
            },
            facilities: {
                title: "Nearest Emergency Facilities",
                cards: [
                    { 
                        id: 1, 
                        type: "fire", 
                        title: "Caloocan Fire Station Main", 
                        address: "226 Maria Clara St, Grace Park East, Caloocan, 1403 Metro Manila", 
                        distance: "1.4 km from Barangay 118", 
                        hours: "24/7 Service", 
                        mapLink: "https://maps.app.goo.gl/BNyMdWZcx3sgE5TV8" 
                    },
                    { 
                        id: 2, 
                        type: "medical", 
                        title: "Caloocan City Medical Center", 
                        address: "3rd Street, 9th Ave, Grace Park East, Caloocan, Metro Manila", 
                        distance: "950 m from Barangay 118", 
                        hours: "24/7 Emergency Room", 
                        mapLink: "https://maps.app.goo.gl/jqq6xJQ7yRbdTT779" 
                    },
                    { 
                        id: 3, 
                        type: "police", 
                        title: "Caloocan Police Station 1", 
                        address: "C3 Road, 8th Street, de Jesus, Grace Park, Caloocan, 1404 Metro Manila", 
                        distance: "1 km from Barangay 118", 
                        hours: "24/7 Emergency", 
                        mapLink: "https://maps.app.goo.gl/gabonpQy56tayH469" 
                    },
                    { 
                        id: 4, 
                        type: "barangay", 
                        title: "Barangay 118 Hall", 
                        address: "402 2nd St, Grace Park East, Caloocan, Metro Manila", 
                        distance: "Within Barangay 118", 
                        hours: "8AM-5PM (Mon-Fri)", 
                        mapLink: "https://maps.app.goo.gl/rnBHFzifAcRywgjx5" 
                    },
                    { 
                        id: 5, 
                        type: "evacuation", 
                        title: "Barangay 118 Covered Court", 
                        address: "3rd Avenue, Grace Park, Caloocan", 
                        distance: "Within Barangay 118", 
                        hours: "Primary barangay-level evacuation center for residents of South Caloocan in case of major earthquakes. Always follow barangay officers' instructions during evacuation.", 
                        mapLink: "https://maps.app.goo.gl/GhfdttvNcnBrA1xAA" 
                    },
                    { 
                        id: 6, 
                        type: "evacuation", 
                        title: "UP Diliman", 
                        address: "University Ave, Diliman, Quezon City, 1101 Metro Manila", 
                        distance: "Approx. 10‚Äì11 km from South Caloocan", 
                        hours: "Part of Metro Manila's North Quadrant primary evacuation centers for major earthquakes ('The Big One'). South Caloocan residents should first evacuate to barangay centers and follow LGU instructions before proceeding here.", 
                        mapLink: "https://maps.app.goo.gl/yMSe4MzefUsyvnwc6" 
                    }
                ]
            },
            preparation: {
                title: "Emergency Preparedness Kit",
                description: "Essential items to prepare for emergencies",
                checklist: [
                    {
                        id: 1,
                        category: "Medical & First Aid",
                        items: [
                            "Bandages and antiseptic",
                            "Prescription medications",
                            "Pain relievers",
                            "Medical gloves"
                        ]
                    },
                    {
                        id: 2,
                        category: "Food & Water",
                        items: [
                            "3-day water supply (1 gallon/person/day)",
                            "Non-perishable food",
                            "Manual can opener",
                            "Energy bars"
                        ]
                    },
                    {
                        id: 3,
                        category: "Light & Communication",
                        items: [
                            "Flashlight with extra batteries",
                            "Portable phone charger",
                            "Battery-powered radio",
                            "Whistle"
                        ]
                    },
                    {
                        id: 4,
                        category: "Important Documents",
                        items: [
                            "Copies of IDs in waterproof container",
                            "Insurance papers",
                            "Medical records",
                            "Emergency contact list"
                        ]
                    }
                ],
                tips: {
                    title: "Important Tips:",
                    items: [
                        "Store kit in accessible location",
                        "Check and update every 6 months",
                        "Have one kit at home and one in car",
                        "Include special needs items (baby, elderly, pets)"
                    ]
                }
            },
            footer: {
                title: "Barangay 118 Online System",
                description: "Secure and efficient online services for Barangay 118. Connecting our community through technology.",
                copyright: "&copy; 2025 Barangay 118 Online System. All Rights Reserved."
            }
        };

        // Enhanced Emergency Admin Panel with Manual Save
        class EmergencyAdminPanel {
            constructor() {
                this.dataKey = 'emergencyContent';
                this.currentData = null;
                this.activityLog = [];
                this.lastSavedData = null;
                this.saveStatusTimeout = null;
                this.renderedTabs = new Set();
                this.currentCategoryId = null;
                this.init();
            }

            init() {
                this.loadData();
                this.lastSavedData = JSON.parse(JSON.stringify(this.currentData));
                this.setupEventListeners();
                this.updateDashboard();
                this.logActivity('Emergency system initialized with pre-loaded data', 'success');
                this.updateSaveStatus('‚Ä¢ Manual Save');
                this.checkUserViewConnection();
                
                this.hideAllTabs();
                this.switchTab('welcome');
            }

            hideAllTabs() {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
            }

            getDefaultData() {
                return JSON.parse(JSON.stringify(defaultEmergencyData));
            }

            loadData() {
                let loaded = false;
                const savedData = localStorage.getItem(this.dataKey);
                if (savedData) {
                    try {
                        this.currentData = JSON.parse(savedData);
                        console.log('Emergency data loaded from localStorage with key:', this.dataKey);
                        loaded = true;
                    } catch (error) {
                        console.error('Error parsing localStorage data:', error);
                    }
                }
                
                if (!loaded) {
                    this.currentData = this.getDefaultData();
                    console.log('Using pre-loaded default emergency data');
                }
                
                this.populateForms();
            }

            hasActualChanges() {
                if (!this.lastSavedData) return true;
                
                const currentDataStr = JSON.stringify(this.currentData);
                const lastSavedDataStr = JSON.stringify(this.lastSavedData);
                
                return currentDataStr !== lastSavedDataStr;
            }

            saveData(forceSave = false) {
                if (!forceSave && !this.hasActualChanges()) {
                    console.log('No changes detected, skipping save');
                    this.updateSaveStatus('No changes to save', 'info');
                    this.showAlert('No changes to save', 'info');
                    return true;
                }

                let saved = false;
                
                try {
                    localStorage.setItem(this.dataKey, JSON.stringify(this.currentData));
                    console.log('Emergency data saved to localStorage with key:', this.dataKey);
                    saved = true;
                    
                    this.lastSavedData = JSON.parse(JSON.stringify(this.currentData));
                    
                    this.updateDashboard();
                    this.updateSaveStatus('Saved successfully', 'success');
                    this.logActivity('Emergency data saved successfully', 'success');
                    
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: this.dataKey,
                        newValue: JSON.stringify(this.currentData)
                    }));
                    
                } catch (error) {
                    console.error('Save failed:', error);
                    this.updateSaveStatus('Save failed', 'error');
                    this.logActivity('Emergency data save failed', 'error');
                    saved = false;
                }
                
                return saved;
            }
            
            updateSaveStatus(message = '‚Ä¢ Manual Save', type = 'default') {
                const statusElement = document.getElementById('save-status');
                if (!statusElement) return;
                
                if (this.saveStatusTimeout) {
                    clearTimeout(this.saveStatusTimeout);
                }
                
                statusElement.textContent = message;
                statusElement.className = 'save-status';
                
                if (type === 'success') {
                    statusElement.classList.add('success');
                } else if (type === 'warning') {
                    statusElement.classList.add('warning');
                } else if (type === 'error') {
                    statusElement.classList.add('error');
                } else if (type === 'info') {
                    statusElement.classList.add('info');
                }
                
                if (type === 'success' || type === 'info' || type === 'warning') {
                    this.saveStatusTimeout = setTimeout(() => {
                        statusElement.textContent = '‚Ä¢ Manual Save';
                        statusElement.className = 'save-status';
                    }, 3000);
                }
            }

            populateForms() {
                if (!this.currentData) return;

                // Hero Form
                document.getElementById('hero-title').value = this.currentData.hero?.title || '';
                document.getElementById('hero-description').value = this.currentData.hero?.description || '';
                
                // Quick Call Section
                document.getElementById('quickcall-section-title').value = this.currentData.quickCall?.title || '';
                document.getElementById('quickcall-section-description').value = this.currentData.quickCall?.description || '';
                
                // Contacts Section
                document.getElementById('contacts-section-title').value = this.currentData.contacts?.title || '';
                
                // Procedures Section
                document.getElementById('procedures-section-title').value = this.currentData.procedures?.title || '';
                document.getElementById('procedures-section-description').value = this.currentData.procedures?.description || '';
                
                // Facilities Section
                document.getElementById('facilities-section-title').value = this.currentData.facilities?.title || '';
                
                // Preparation Section
                document.getElementById('preparation-section-title').value = this.currentData.preparation?.title || '';
                document.getElementById('preparation-section-description').value = this.currentData.preparation?.description || '';
                document.getElementById('preparation-tips-title').value = this.currentData.preparation?.tips?.title || '';
                
                // Footer Form
                document.getElementById('footer-title').value = this.currentData.footer?.title || '';
                document.getElementById('footer-description').value = this.currentData.footer?.description || '';
                document.getElementById('footer-copyright').value = this.currentData.footer?.copyright || '';
            }

            setupEventListeners() {
                // Sidebar navigation
                document.querySelector('.sidebar-menu').addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (link && link.hasAttribute('data-tab')) {
                        e.preventDefault();
                        const tabId = link.getAttribute('data-tab');
                        this.switchTab(tabId);
                    }
                });

                // Sidebar logout button
                document.querySelector('.sidebar-logout-btn').addEventListener('click', (e) => {
                    if (!confirm('Are you sure you want to logout?')) {
                        e.preventDefault();
                    }
                });

                // Sub-tabs
                document.querySelectorAll('[data-quickcall-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchQuickCallTab(tab.getAttribute('data-quickcall-tab'));
                    });
                });

                document.querySelectorAll('[data-contacts-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchContactsTab(tab.getAttribute('data-contacts-tab'));
                    });
                });

                document.querySelectorAll('[data-procedures-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchProceduresTab(tab.getAttribute('data-procedures-tab'));
                    });
                });

                document.querySelectorAll('[data-facilities-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchFacilitiesTab(tab.getAttribute('data-facilities-tab'));
                    });
                });

                document.querySelectorAll('[data-preparation-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchPreparationTab(tab.getAttribute('data-preparation-tab'));
                    });
                });

                // Form submissions
                this.setupFormListeners();

                // Quick action buttons
                document.getElementById('preview-emergency-btn').addEventListener('click', () => {
                    window.open('Emergency.html', '_blank');
                });

                document.getElementById('export-emergency-btn').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('backup-emergency-btn').addEventListener('click', () => {
                    this.exportData();
                    this.showAlert('Emergency backup created successfully!', 'success');
                });

                document.getElementById('refresh-emergency-btn').addEventListener('click', () => {
                    this.loadData();
                    this.showAlert('Emergency data refreshed!', 'success');
                });

                document.getElementById('clear-emergency-data-btn').addEventListener('click', () => {
                    if (confirm('Clear ALL emergency data? This will remove everything and cannot be undone.')) {
                        this.clearAllData();
                    }
                });

                // Icon picker
                document.querySelectorAll('.icon-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        document.getElementById('procedures-icon').value = option.getAttribute('data-icon');
                    });
                });

                // Search handlers
                document.getElementById('quickcall-search').addEventListener('input', (e) => {
                    this.searchQuickCall(e.target.value);
                });

                document.getElementById('contacts-search').addEventListener('input', (e) => {
                    this.searchContacts(e.target.value);
                });

                document.getElementById('procedures-search').addEventListener('input', (e) => {
                    this.searchProcedures(e.target.value);
                });

                document.getElementById('facilities-search').addEventListener('input', (e) => {
                    this.searchFacilities(e.target.value);
                });

                document.getElementById('preparation-search').addEventListener('input', (e) => {
                    this.searchPreparation(e.target.value);
                });

                // Prevent form submission from reloading page
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                    });
                });

                // Contacts form tabs
                document.querySelectorAll('[data-contacts-form-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchContactsFormTab(tab.getAttribute('data-contacts-form-tab'));
                    });
                });

                // Add step button
                document.getElementById('add-step-btn').addEventListener('click', () => {
                    this.addProcedureStep();
                });

                // Add checklist item button
                document.getElementById('add-checklist-item-btn').addEventListener('click', () => {
                    this.addChecklistItem();
                });

                // Add tip button
                document.getElementById('add-tip-btn').addEventListener('click', () => {
                    this.addTipItem();
                });

                // Contacts buttons
                document.getElementById('next-to-items-btn').addEventListener('click', () => {
                    this.switchContactsFormTab('items');
                });

                document.getElementById('back-to-category-btn').addEventListener('click', () => {
                    this.switchContactsFormTab('category');
                });

                document.getElementById('add-contact-item-btn').addEventListener('click', () => {
                    this.addContactItem();
                });
            }

            setupFormListeners() {
                // Hero Form
                document.getElementById('hero-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const oldData = {...this.currentData.hero};
                    const newData = {
                        title: document.getElementById('hero-title').value,
                        description: document.getElementById('hero-description').value
                    };
                    
                    if (JSON.stringify(oldData) !== JSON.stringify(newData)) {
                        this.currentData.hero = newData;
                        this.saveData();
                        this.showAlert('Hero section updated successfully!', 'success');
                        this.logActivity('Hero section updated', 'success');
                    } else {
                        this.showAlert('No changes detected in Hero section', 'info');
                    }
                });

                // Hero Reset to Defaults
                document.getElementById('hero-reset-btn').addEventListener('click', () => {
                    if (confirm('Reset Hero section to defaults? This will reset and save immediately.')) {
                        const defaultData = this.getDefaultData();
                        const currentHero = {...this.currentData.hero};
                        
                        this.currentData.hero = {...defaultData.hero};
                        
                        document.getElementById('hero-title').value = defaultData.hero.title;
                        document.getElementById('hero-description').value = defaultData.hero.description;
                        
                        this.saveData(true);
                        this.showAlert('Hero section reset to defaults and saved!', 'success');
                        this.logActivity('Hero section reset to defaults and saved', 'warning');
                    }
                });

                // Quick Call Form
                document.getElementById('quickcall-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const editId = document.getElementById('quickcall-edit-id').value;
                    const isEditing = editId !== '';

                    const quickCallData = {
                        id: isEditing ? parseInt(editId) : (this.currentData.quickCall.cards.length > 0 ? 
                            Math.max(...this.currentData.quickCall.cards.map(c => c.id)) + 1 : 1),
                        type: document.getElementById('quickcall-type').value,
                        title: document.getElementById('quickcall-title').value,
                        subtitle: document.getElementById('quickcall-subtitle').value,
                        number: document.getElementById('quickcall-number').value
                    };

                    if (isEditing) {
                        const index = this.currentData.quickCall.cards.findIndex(c => c.id == editId);
                        if (index !== -1) {
                            this.currentData.quickCall.cards[index] = quickCallData;
                        }
                        this.logActivity(`Quick call contact updated: "${quickCallData.title}"`, 'success');
                        this.showAlert('Quick call contact updated successfully!', 'success');
                    } else {
                        this.currentData.quickCall.cards.push(quickCallData);
                        this.logActivity(`Quick call contact added: "${quickCallData.title}"`, 'success');
                        this.showAlert('Quick call contact added successfully!', 'success');
                    }

                    this.saveData();
                    this.renderQuickCallTable();

                    document.getElementById('quickcall-form').reset();
                    document.getElementById('quickcall-edit-id').value = '';
                    document.getElementById('quickcall-submit-btn').innerHTML = '<i class="fas fa-plus-circle"></i> Add Contact';
                    document.getElementById('quickcall-cancel-edit').style.display = 'none';

                    if (isEditing) {
                        this.switchQuickCallTab('existing');
                    }
                });

                // Quick Call Section Form
                document.getElementById('quickcall-section-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const oldData = {...this.currentData.quickCall};
                    const newData = {
                        title: document.getElementById('quickcall-section-title').value,
                        description: document.getElementById('quickcall-section-description').value,
                        cards: this.currentData.quickCall.cards
                    };
                    
                    if (JSON.stringify(oldData) !== JSON.stringify(newData)) {
                        this.currentData.quickCall = newData;
                        this.saveData();
                        this.showAlert('Quick call section updated successfully!', 'success');
                        this.logActivity('Quick call section updated', 'success');
                    } else {
                        this.showAlert('No changes detected in Quick call section', 'info');
                    }
                });

                // Contacts Form
                document.getElementById('contacts-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    // This is handled by individual buttons in the contacts form
                });

                // Procedures Form
                document.getElementById('procedures-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const editId = document.getElementById('procedures-edit-id').value;
                    const isEditing = editId !== '';

                    const steps = [];
                    document.querySelectorAll('#procedure-steps-container .step-input').forEach(input => {
                        if (input.value.trim()) {
                            steps.push(input.value.trim());
                        }
                    });

                    const procedureData = {
                        id: isEditing ? parseInt(editId) : (this.currentData.procedures.cards.length > 0 ? 
                            Math.max(...this.currentData.procedures.cards.map(p => p.id)) + 1 : 1),
                        icon: document.getElementById('procedures-icon').value,
                        title: document.getElementById('procedures-title').value,
                        steps: steps
                    };

                    if (isEditing) {
                        const index = this.currentData.procedures.cards.findIndex(p => p.id == editId);
                        if (index !== -1) {
                            this.currentData.procedures.cards[index] = procedureData;
                        }
                        this.logActivity(`Procedure updated: "${procedureData.title}"`, 'success');
                        this.showAlert('Procedure updated successfully!', 'success');
                    } else {
                        this.currentData.procedures.cards.push(procedureData);
                        this.logActivity(`Procedure added: "${procedureData.title}"`, 'success');
                        this.showAlert('Procedure added successfully!', 'success');
                    }

                    this.saveData();
                    this.renderProceduresTable();

                    document.getElementById('procedures-form').reset();
                    document.getElementById('procedures-edit-id').value = '';
                    document.getElementById('procedures-submit-btn').innerHTML = '<i class="fas fa-plus-circle"></i> Add Procedure';
                    document.getElementById('procedures-cancel-edit').style.display = 'none';
                    document.getElementById('procedure-steps-container').innerHTML = '';

                    if (isEditing) {
                        this.switchProceduresTab('existing');
                    }
                });

                // Facilities Form
                document.getElementById('facilities-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const editId = document.getElementById('facilities-edit-id').value;
                    const isEditing = editId !== '';

                    const facilityData = {
                        id: isEditing ? parseInt(editId) : (this.currentData.facilities.cards.length > 0 ? 
                            Math.max(...this.currentData.facilities.cards.map(f => f.id)) + 1 : 1),
                        type: document.getElementById('facilities-type').value,
                        title: document.getElementById('facilities-name').value,
                        address: document.getElementById('facilities-address').value,
                        distance: document.getElementById('facilities-distance').value,
                        hours: document.getElementById('facilities-hours').value,
                        mapLink: document.getElementById('facilities-map-link').value
                    };

                    if (isEditing) {
                        const index = this.currentData.facilities.cards.findIndex(f => f.id == editId);
                        if (index !== -1) {
                            this.currentData.facilities.cards[index] = facilityData;
                        }
                        this.logActivity(`Facility updated: "${facilityData.title}"`, 'success');
                        this.showAlert('Facility updated successfully!', 'success');
                    } else {
                        this.currentData.facilities.cards.push(facilityData);
                        this.logActivity(`Facility added: "${facilityData.title}"`, 'success');
                        this.showAlert('Facility added successfully!', 'success');
                    }

                    this.saveData();
                    this.renderFacilitiesTable();

                    document.getElementById('facilities-form').reset();
                    document.getElementById('facilities-edit-id').value = '';
                    document.getElementById('facilities-submit-btn').innerHTML = '<i class="fas fa-plus-circle"></i> Add Facility';
                    document.getElementById('facilities-cancel-edit').style.display = 'none';

                    if (isEditing) {
                        this.switchFacilitiesTab('existing');
                    }
                });

                // Preparation Form
                document.getElementById('preparation-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const editId = document.getElementById('preparation-edit-id').value;
                    const isEditing = editId !== '';

                    const items = [];
                    document.querySelectorAll('#preparation-items-container .category-input').forEach(input => {
                        if (input.value.trim()) {
                            items.push(input.value.trim());
                        }
                    });

                    const preparationData = {
                        id: isEditing ? parseInt(editId) : (this.currentData.preparation.checklist.length > 0 ? 
                            Math.max(...this.currentData.preparation.checklist.map(c => c.id)) + 1 : 1),
                        category: document.getElementById('preparation-category').value,
                        items: items
                    };

                    if (isEditing) {
                        const index = this.currentData.preparation.checklist.findIndex(c => c.id == editId);
                        if (index !== -1) {
                            this.currentData.preparation.checklist[index] = preparationData;
                        }
                        this.logActivity(`Preparation category updated: "${preparationData.category}"`, 'success');
                        this.showAlert('Preparation category updated successfully!', 'success');
                    } else {
                        this.currentData.preparation.checklist.push(preparationData);
                        this.logActivity(`Preparation category added: "${preparationData.category}"`, 'success');
                        this.showAlert('Preparation category added successfully!', 'success');
                    }

                    this.saveData();
                    this.renderPreparationChecklist();

                    document.getElementById('preparation-form').reset();
                    document.getElementById('preparation-edit-id').value = '';
                    document.getElementById('preparation-submit-btn').innerHTML = '<i class="fas fa-plus-circle"></i> Add Category';
                    document.getElementById('preparation-cancel-edit').style.display = 'none';
                    document.getElementById('preparation-items-container').innerHTML = '';

                    if (isEditing) {
                        this.switchPreparationTab('existing');
                    }
                });

                // Preparation Tips Form
                document.getElementById('preparation-tips-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const items = [];
                    document.querySelectorAll('#preparation-tips-container .category-input').forEach(input => {
                        if (input.value.trim()) {
                            items.push(input.value.trim());
                        }
                    });

                    const tipsData = {
                        title: document.getElementById('preparation-tips-title').value,
                        items: items
                    };

                    this.currentData.preparation.tips = tipsData;
                    this.saveData();
                    this.showAlert('Preparation tips updated successfully!', 'success');
                    this.logActivity('Preparation tips updated', 'success');
                });

                // Footer Form
                document.getElementById('footer-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const oldData = {...this.currentData.footer};
                    const newData = {
                        title: document.getElementById('footer-title').value,
                        description: document.getElementById('footer-description').value,
                        copyright: document.getElementById('footer-copyright').value
                    };
                    
                    if (JSON.stringify(oldData) !== JSON.stringify(newData)) {
                        this.currentData.footer = newData;
                        this.saveData();
                        this.showAlert('Footer updated successfully!', 'success');
                        this.logActivity('Footer updated', 'success');
                    } else {
                        this.showAlert('No changes detected in Footer', 'info');
                    }
                });

                // Reset buttons
                this.setupResetButtons();
            }

            setupResetButtons() {
                // Quick Call Reset All
                document.getElementById('quickcall-reset-btn').addEventListener('click', () => {
                    if (confirm('Reset ALL quick call contacts to defaults? This will remove all current contacts and restore defaults.')) {
                        const defaultData = this.getDefaultData();
                        this.currentData.quickCall.cards = [...defaultData.quickCall.cards];
                        this.saveData();
                        this.renderQuickCallTable();
                        this.showAlert('All quick call contacts reset to defaults!', 'success');
                        this.logActivity('All quick call contacts reset to defaults', 'warning');
                    }
                });

                // Procedures Reset All
                document.getElementById('procedures-reset-btn').addEventListener('click', () => {
                    if (confirm('Reset ALL procedures to defaults? This will remove all current procedures and restore defaults.')) {
                        const defaultData = this.getDefaultData();
                        this.currentData.procedures.cards = [...defaultData.procedures.cards];
                        this.saveData();
                        this.renderProceduresTable();
                        this.showAlert('All procedures reset to defaults!', 'success');
                        this.logActivity('All procedures reset to defaults', 'warning');
                    }
                });

                // Facilities Reset All
                document.getElementById('facilities-reset-btn').addEventListener('click', () => {
                    if (confirm('Reset ALL facilities to defaults? This will remove all current facilities and restore defaults.')) {
                        const defaultData = this.getDefaultData();
                        this.currentData.facilities.cards = [...defaultData.facilities.cards];
                        this.saveData();
                        this.renderFacilitiesTable();
                        this.showAlert('All facilities reset to defaults!', 'success');
                        this.logActivity('All facilities reset to defaults', 'warning');
                    }
                });

                // Preparation Reset All
                document.getElementById('preparation-reset-btn').addEventListener('click', () => {
                    if (confirm('Reset ALL preparation categories to defaults? This will remove all current categories and restore defaults.')) {
                        const defaultData = this.getDefaultData();
                        this.currentData.preparation.checklist = [...defaultData.preparation.checklist];
                        this.saveData();
                        this.renderPreparationChecklist();
                        this.showAlert('All preparation categories reset to defaults!', 'success');
                        this.logActivity('All preparation categories reset to defaults', 'warning');
                    }
                });
            }

            switchTab(tabId) {
                console.log('Switching to tab:', tabId);
                
                document.querySelectorAll('.sidebar-menu a').forEach(item => {
                    item.classList.remove('active');
                });
                const targetLink = document.querySelector(`[data-tab="${tabId}"]`);
                if (targetLink) {
                    targetLink.classList.add('active');
                }
                
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const selectedTab = document.getElementById(tabId);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }
                
                this.updateQuickGuide(tabId);
                
                document.querySelector('.admin-content').scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });

                // Load specific content for certain tabs
                if (tabId === 'quickcall' && !this.renderedTabs.has('quickcall')) {
                    this.renderQuickCallTable();
                    this.renderedTabs.add('quickcall');
                } else if (tabId === 'contacts' && !this.renderedTabs.has('contacts')) {
                    this.renderContactsAccordion();
                    this.renderedTabs.add('contacts');
                } else if (tabId === 'procedures' && !this.renderedTabs.has('procedures')) {
                    this.renderProceduresTable();
                    this.renderedTabs.add('procedures');
                } else if (tabId === 'facilities' && !this.renderedTabs.has('facilities')) {
                    this.renderFacilitiesTable();
                    this.renderedTabs.add('facilities');
                } else if (tabId === 'preparation' && !this.renderedTabs.has('preparation')) {
                    this.renderPreparationChecklist();
                    this.renderedTabs.add('preparation');
                }
            }

            switchQuickCallTab(tab) {
                document.querySelectorAll('[data-quickcall-tab]').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-quickcall-tab="${tab}"]`).classList.add('active');

                document.querySelectorAll('#quickcall .tab-content').forEach(t => t.classList.remove('active'));
                if (tab === 'existing') {
                    document.getElementById('existing-quickcall').classList.add('active');
                } else if (tab === 'add') {
                    document.getElementById('add-quickcall').classList.add('active');
                } else if (tab === 'section') {
                    document.getElementById('section-quickcall').classList.add('active');
                }
            }

            switchContactsTab(tab) {
                document.querySelectorAll('[data-contacts-tab]').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-contacts-tab="${tab}"]`).classList.add('active');

                document.querySelectorAll('#contacts .tab-content').forEach(t => t.classList.remove('active'));
                if (tab === 'existing') {
                    document.getElementById('existing-contacts').classList.add('active');
                } else if (tab === 'add') {
                    document.getElementById('add-contacts').classList.add('active');
                } else if (tab === 'section') {
                    document.getElementById('section-contacts').classList.add('active');
                }
            }

            switchProceduresTab(tab) {
                document.querySelectorAll('[data-procedures-tab]').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-procedures-tab="${tab}"]`).classList.add('active');

                document.querySelectorAll('#procedures .tab-content').forEach(t => t.classList.remove('active'));
                if (tab === 'existing') {
                    document.getElementById('existing-procedures').classList.add('active');
                } else if (tab === 'add') {
                    document.getElementById('add-procedures').classList.add('active');
                } else if (tab === 'section') {
                    document.getElementById('section-procedures').classList.add('active');
                }
            }

            switchFacilitiesTab(tab) {
                document.querySelectorAll('[data-facilities-tab]').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-facilities-tab="${tab}"]`).classList.add('active');

                document.querySelectorAll('#facilities .tab-content').forEach(t => t.classList.remove('active'));
                if (tab === 'existing') {
                    document.getElementById('existing-facilities').classList.add('active');
                } else if (tab === 'add') {
                    document.getElementById('add-facilities').classList.add('active');
                } else if (tab === 'section') {
                    document.getElementById('section-facilities').classList.add('active');
                }
            }

            switchPreparationTab(tab) {
                document.querySelectorAll('[data-preparation-tab]').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-preparation-tab="${tab}"]`).classList.add('active');

                document.querySelectorAll('#preparation .tab-content').forEach(t => t.classList.remove('active'));
                if (tab === 'existing') {
                    document.getElementById('existing-preparation').classList.add('active');
                } else if (tab === 'add') {
                    document.getElementById('add-preparation').classList.add('active');
                } else if (tab === 'tips') {
                    document.getElementById('tips-preparation').classList.add('active');
                } else if (tab === 'section') {
                    document.getElementById('section-preparation').classList.add('active');
                }
            }

            switchContactsFormTab(tab) {
                document.querySelectorAll('[data-contacts-form-tab]').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-contacts-form-tab="${tab}"]`).classList.add('active');

                document.querySelectorAll('#contacts-form .tab-content').forEach(t => t.classList.remove('active'));
                if (tab === 'category') {
                    document.getElementById('category-contacts-form').classList.add('active');
                } else if (tab === 'items') {
                    document.getElementById('items-contacts-form').classList.add('active');
                }
            }

            updateQuickGuide(tabId) {
                document.querySelectorAll('.guide-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                const guideId = `${tabId}-guide`;
                const guideSection = document.getElementById(guideId);
                if (guideSection) {
                    guideSection.style.display = 'block';
                }
            }

            updateDashboard() {
                if (!this.currentData) return;
                
                document.getElementById('system-status').textContent = 'Ready';
                document.getElementById('total-contacts').textContent = this.currentData.contacts?.accordions?.reduce((total, acc) => total + (acc.items?.length || 0), 0) || 0;
                document.getElementById('total-facilities').textContent = this.currentData.facilities?.cards?.length || 0;
                
                const dataSize = JSON.stringify(this.currentData).length;
                document.getElementById('data-size').textContent = `${Math.round(dataSize / 1024)} KB`;
            }

            // Render methods
            renderQuickCallTable() {
                const tbody = document.getElementById('quickcall-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (!this.currentData.quickCall.cards || this.currentData.quickCall.cards.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--gray); padding: 30px;">No quick call contacts yet. Add your first contact!</td></tr>`;
                    return;
                }

                this.currentData.quickCall.cards.forEach((contact) => {
                    const typeBadge = `<span class="type-badge type-${contact.type}">${contact.type}</span>`;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${typeBadge}</td>
                        <td><strong>${contact.title}</strong></td>
                        <td>${contact.subtitle || 'No subtitle'}</td>
                        <td>${contact.number}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm edit-quickcall" data-id="${contact.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm delete-quickcall" data-id="${contact.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Attach event listeners
                document.querySelectorAll('.delete-quickcall').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.deleteQuickCall(id);
                    });
                });

                document.querySelectorAll('.edit-quickcall').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.editQuickCall(id);
                    });
                });
            }

            renderContactsAccordion() {
                const preview = document.getElementById('contacts-accordion-preview');
                if (!preview) return;
                
                preview.innerHTML = '';

                if (!this.currentData.contacts.accordions || this.currentData.contacts.accordions.length === 0) {
                    preview.innerHTML = `<div style="text-align: center; color: var(--gray); padding: 30px;">No contact categories yet. Add your first category!</div>`;
                    return;
                }

                this.currentData.contacts.accordions.forEach((accordion, index) => {
                    const accordionDiv = document.createElement('div');
                    accordionDiv.className = 'accordion-preview';
                    
                    let itemsHtml = '';
                    accordion.items.forEach(item => {
                        itemsHtml += `
                            <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: var(--radius); border: 1px solid var(--border);">
                                <h4 style="margin-bottom: 5px;">${item.title}</h4>
                                <div style="color: var(--primary); font-weight: 600; margin-bottom: 5px;">${item.number}</div>
                                <p style="color: var(--gray); margin-bottom: 5px;">${item.description}</p>
                                <div style="color: var(--success); font-size: 0.85rem;">${item.hours}</div>
                            </div>
                        `;
                    });
                    
                    accordionDiv.innerHTML = `
                        <div class="accordion-preview-header">
                            <span>${accordion.title}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-preview-content">
                            ${itemsHtml}
                            <div style="text-align: right; margin-top: 15px;">
                                <button class="btn btn-primary btn-sm edit-contacts" data-id="${accordion.id}">
                                    <i class="fas fa-edit"></i> Edit Category
                                </button>
                                <button class="btn btn-danger btn-sm delete-contacts" data-id="${accordion.id}">
                                    <i class="fas fa-trash"></i> Delete Category
                                </button>
                            </div>
                        </div>
                    `;
                    
                    preview.appendChild(accordionDiv);
                    
                    // Add click event to toggle accordion
                    const header = accordionDiv.querySelector('.accordion-preview-header');
                    const content = accordionDiv.querySelector('.accordion-preview-content');
                    const icon = accordionDiv.querySelector('.fa-chevron-down');
                    
                    header.addEventListener('click', () => {
                        const isActive = content.style.display === 'block';
                        content.style.display = isActive ? 'none' : 'block';
                        icon.style.transform = isActive ? 'rotate(0deg)' : 'rotate(180deg)';
                    });
                    
                    // Open first accordion by default
                    if (index === 0) {
                        content.style.display = 'block';
                        icon.style.transform = 'rotate(180deg)';
                    } else {
                        content.style.display = 'none';
                    }
                });

                // Attach event listeners for edit and delete buttons
                document.querySelectorAll('.edit-contacts').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.editContacts(id);
                    });
                });

                document.querySelectorAll('.delete-contacts').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.deleteContacts(id);
                    });
                });
            }

            renderProceduresTable() {
                const tbody = document.getElementById('procedures-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (!this.currentData.procedures.cards || this.currentData.procedures.cards.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--gray); padding: 30px;">No procedures yet. Add your first procedure!</td></tr>`;
                    return;
                }

                this.currentData.procedures.cards.forEach((procedure) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><i class="${procedure.icon}"></i></td>
                        <td><strong>${procedure.title}</strong></td>
                        <td>${procedure.steps.length} steps</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm edit-procedures" data-id="${procedure.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm delete-procedures" data-id="${procedure.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Attach event listeners
                document.querySelectorAll('.delete-procedures').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.deleteProcedures(id);
                    });
                });

                document.querySelectorAll('.edit-procedures').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.editProcedures(id);
                    });
                });
            }

            renderFacilitiesTable() {
                const tbody = document.getElementById('facilities-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (!this.currentData.facilities.cards || this.currentData.facilities.cards.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--gray); padding: 30px;">No facilities yet. Add your first facility!</td></tr>`;
                    return;
                }

                this.currentData.facilities.cards.forEach((facility) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="type-badge type-${facility.type}">${facility.type}</span></td>
                        <td><strong>${facility.title}</strong></td>
                        <td>${facility.address.substring(0, 50)}${facility.address.length > 50 ? '...' : ''}</td>
                        <td>${facility.distance || 'Not specified'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm edit-facilities" data-id="${facility.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm delete-facilities" data-id="${facility.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Attach event listeners
                document.querySelectorAll('.delete-facilities').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.deleteFacilities(id);
                    });
                });

                document.querySelectorAll('.edit-facilities').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.editFacilities(id);
                    });
                });
            }

            renderPreparationChecklist() {
                const preview = document.getElementById('preparation-checklist-preview');
                if (!preview) return;
                
                preview.innerHTML = '';

                if (!this.currentData.preparation.checklist || this.currentData.preparation.checklist.length === 0) {
                    preview.innerHTML = `<div style="text-align: center; color: var(--gray); padding: 30px;">No preparation categories yet. Add your first category!</div>`;
                    return;
                }

                this.currentData.preparation.checklist.forEach((category) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'accordion-preview';
                    
                    let itemsHtml = '<ul>';
                    category.items.forEach(item => {
                        itemsHtml += `<li style="margin-bottom: 5px;">${item}</li>`;
                    });
                    itemsHtml += '</ul>';
                    
                    categoryDiv.innerHTML = `
                        <div class="accordion-preview-header">
                            <span>${category.category}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-preview-content">
                            ${itemsHtml}
                            <div style="text-align: right; margin-top: 15px;">
                                <button class="btn btn-primary btn-sm edit-preparation" data-id="${category.id}">
                                    <i class="fas fa-edit"></i> Edit Category
                                </button>
                                <button class="btn btn-danger btn-sm delete-preparation" data-id="${category.id}">
                                    <i class="fas fa-trash"></i> Delete Category
                                </button>
                            </div>
                        </div>
                    `;
                    
                    preview.appendChild(categoryDiv);
                    
                    // Add click event to toggle accordion
                    const header = categoryDiv.querySelector('.accordion-preview-header');
                    const content = categoryDiv.querySelector('.accordion-preview-content');
                    const icon = categoryDiv.querySelector('.fa-chevron-down');
                    
                    header.addEventListener('click', () => {
                        const isActive = content.style.display === 'block';
                        content.style.display = isActive ? 'none' : 'block';
                        icon.style.transform = isActive ? 'rotate(0deg)' : 'rotate(180deg)';
                    });
                    
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(180deg)';
                });

                // Attach event listeners
                document.querySelectorAll('.edit-preparation').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.editPreparation(id);
                    });
                });

                document.querySelectorAll('.delete-preparation').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('button').getAttribute('data-id'));
                        this.deletePreparation(id);
                    });
                });
            }

            // Edit methods
            editQuickCall(id) {
                const contact = this.currentData.quickCall.cards.find(c => c.id === id);
                if (!contact) return;
                
                this.switchQuickCallTab('add');
                
                document.getElementById('quickcall-edit-id').value = contact.id;
                document.getElementById('quickcall-title').value = contact.title;
                document.getElementById('quickcall-subtitle').value = contact.subtitle || '';
                document.getElementById('quickcall-number').value = contact.number;
                document.getElementById('quickcall-type').value = contact.type;
                
                document.getElementById('quickcall-submit-btn').innerHTML = '<i class="fas fa-save"></i> Update Contact';
                document.getElementById('quickcall-cancel-edit').style.display = 'inline-block';
                
                this.logActivity(`Editing quick call contact: "${contact.title}"`, 'info');
            }

            editContacts(id) {
                const accordion = this.currentData.contacts.accordions.find(a => a.id === id);
                if (!accordion) return;
                
                this.switchContactsTab('add');
                this.currentCategoryId = accordion.id;
                
                document.getElementById('contacts-edit-id').value = accordion.id;
                document.getElementById('contacts-category-title').value = accordion.title;
                document.getElementById('current-category-title').textContent = accordion.title;
                
                // Clear and populate contact items
                const itemsContainer = document.getElementById('contact-items-list');
                itemsContainer.innerHTML = '';
                
                accordion.items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'contact-item-form';
                    itemDiv.innerHTML = `
                        <div style="border: 1px solid var(--border); padding: 15px; border-radius: var(--radius); margin-bottom: 15px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" class="form-control contact-item-title" value="${item.title}" placeholder="Contact title">
                                </div>
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="text" class="form-control contact-item-number" value="${item.number}" placeholder="Phone number">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-control contact-item-description" placeholder="Description">${item.description}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Hours/Availability</label>
                                <input type="text" class="form-control contact-item-hours" value="${item.hours}" placeholder="e.g., Available: 24/7">
                            </div>
                            <button type="button" class="btn btn-danger btn-sm remove-contact-item" style="margin-top: 10px;">
                                <i class="fas fa-trash"></i> Remove Item
                            </button>
                        </div>
                    `;
                    itemsContainer.appendChild(itemDiv);
                });
                
                document.getElementById('save-category-btn').innerHTML = '<i class="fas fa-save"></i> Update Category';
                
                this.logActivity(`Editing contacts category: "${accordion.title}"`, 'info');
            }

            editProcedures(id) {
                const procedure = this.currentData.procedures.cards.find(p => p.id === id);
                if (!procedure) return;
                
                this.switchProceduresTab('add');
                
                document.getElementById('procedures-edit-id').value = procedure.id;
                document.getElementById('procedures-title').value = procedure.title;
                document.getElementById('procedures-icon').value = procedure.icon;
                
                // Select the icon in the picker
                document.querySelectorAll('.icon-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.getAttribute('data-icon') === procedure.icon) {
                        option.classList.add('selected');
                    }
                });
                
                // Clear and populate steps
                const stepsContainer = document.getElementById('procedure-steps-container');
                stepsContainer.innerHTML = '';
                
                procedure.steps.forEach((step, index) => {
                    this.addProcedureStep(step);
                });
                
                document.getElementById('procedures-submit-btn').innerHTML = '<i class="fas fa-save"></i> Update Procedure';
                document.getElementById('procedures-cancel-edit').style.display = 'inline-block';
                
                this.logActivity(`Editing procedure: "${procedure.title}"`, 'info');
            }

            editFacilities(id) {
                const facility = this.currentData.facilities.cards.find(f => f.id === id);
                if (!facility) return;
                
                this.switchFacilitiesTab('add');
                
                document.getElementById('facilities-edit-id').value = facility.id;
                document.getElementById('facilities-name').value = facility.title;
                document.getElementById('facilities-type').value = facility.type;
                document.getElementById('facilities-address').value = facility.address;
                document.getElementById('facilities-distance').value = facility.distance || '';
                document.getElementById('facilities-hours').value = facility.hours || '';
                document.getElementById('facilities-map-link').value = facility.mapLink;
                
                document.getElementById('facilities-submit-btn').innerHTML = '<i class="fas fa-save"></i> Update Facility';
                document.getElementById('facilities-cancel-edit').style.display = 'inline-block';
                
                this.logActivity(`Editing facility: "${facility.title}"`, 'info');
            }

            editPreparation(id) {
                const category = this.currentData.preparation.checklist.find(c => c.id === id);
                if (!category) return;
                
                this.switchPreparationTab('add');
                
                document.getElementById('preparation-edit-id').value = category.id;
                document.getElementById('preparation-category').value = category.category;
                
                // Clear and populate items
                const itemsContainer = document.getElementById('preparation-items-container');
                itemsContainer.innerHTML = '';
                
                category.items.forEach((item, index) => {
                    this.addChecklistItem(item);
                });
                
                document.getElementById('preparation-submit-btn').innerHTML = '<i class="fas fa-save"></i> Update Category';
                document.getElementById('preparation-cancel-edit').style.display = 'inline-block';
                
                this.logActivity(`Editing preparation category: "${category.category}"`, 'info');
            }

            // Delete methods
            deleteQuickCall(id) {
                if (confirm('Are you sure you want to delete this quick call contact?')) {
                    this.currentData.quickCall.cards = this.currentData.quickCall.cards.filter(c => c.id !== id);
                    this.saveData();
                    this.renderQuickCallTable();
                    this.logActivity(`Quick call contact deleted`, 'error');
                    this.showAlert('Quick call contact deleted successfully', 'success');
                }
            }

            deleteContacts(id) {
                if (confirm('Are you sure you want to delete this contact category and all its items?')) {
                    this.currentData.contacts.accordions = this.currentData.contacts.accordions.filter(a => a.id !== id);
                    this.saveData();
                    this.renderContactsAccordion();
                    this.logActivity(`Contact category deleted`, 'error');
                    this.showAlert('Contact category deleted successfully', 'success');
                }
            }

            deleteProcedures(id) {
                if (confirm('Are you sure you want to delete this procedure?')) {
                    this.currentData.procedures.cards = this.currentData.procedures.cards.filter(p => p.id !== id);
                    this.saveData();
                    this.renderProceduresTable();
                    this.logActivity(`Procedure deleted`, 'error');
                    this.showAlert('Procedure deleted successfully', 'success');
                }
            }

            deleteFacilities(id) {
                if (confirm('Are you sure you want to delete this facility?')) {
                    this.currentData.facilities.cards = this.currentData.facilities.cards.filter(f => f.id !== id);
                    this.saveData();
                    this.renderFacilitiesTable();
                    this.logActivity(`Facility deleted`, 'error');
                    this.showAlert('Facility deleted successfully', 'success');
                }
            }

            deletePreparation(id) {
                if (confirm('Are you sure you want to delete this preparation category?')) {
                    this.currentData.preparation.checklist = this.currentData.preparation.checklist.filter(c => c.id !== id);
                    this.saveData();
                    this.renderPreparationChecklist();
                    this.logActivity(`Preparation category deleted`, 'error');
                    this.showAlert('Preparation category deleted successfully', 'success');
                }
            }

            // Helper methods for dynamic forms
            addProcedureStep(value = '') {
                const container = document.getElementById('procedure-steps-container');
                const stepCount = container.children.length + 1;
                
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-item';
                stepDiv.innerHTML = `
                    <div class="step-number">${stepCount}</div>
                    <input type="text" class="form-control step-input" value="${value}" placeholder="Enter step ${stepCount}">
                    <div class="step-actions">
                        <button type="button" class="btn btn-danger btn-sm remove-step">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(stepDiv);
                
                // Add event listener to remove button
                stepDiv.querySelector('.remove-step').addEventListener('click', () => {
                    stepDiv.remove();
                    this.renumberProcedureSteps();
                });
            }

            renumberProcedureSteps() {
                const steps = document.querySelectorAll('#procedure-steps-container .step-item');
                steps.forEach((step, index) => {
                    step.querySelector('.step-number').textContent = index + 1;
                });
            }

            addChecklistItem(value = '') {
                const container = document.getElementById('preparation-items-container');
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'category-item';
                itemDiv.innerHTML = `
                    <input type="checkbox" class="category-checkbox" checked disabled>
                    <input type="text" class="form-control category-input" value="${value}" placeholder="Enter checklist item">
                    <button type="button" class="btn btn-danger btn-sm remove-checklist-item">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(itemDiv);
                
                // Add event listener to remove button
                itemDiv.querySelector('.remove-checklist-item').addEventListener('click', () => {
                    itemDiv.remove();
                });
            }

            addTipItem(value = '') {
                const container = document.getElementById('preparation-tips-container');
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'category-item';
                itemDiv.innerHTML = `
                    <div style="color: var(--primary); font-weight: bold; width: 20px;">‚Ä¢</div>
                    <input type="text" class="form-control category-input" value="${value}" placeholder="Enter tip">
                    <button type="button" class="btn btn-danger btn-sm remove-tip-item">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(itemDiv);
                
                // Add event listener to remove button
                itemDiv.querySelector('.remove-tip-item').addEventListener('click', () => {
                    itemDiv.remove();
                });
            }

            addContactItem() {
                const container = document.getElementById('contact-items-list');
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'contact-item-form';
                itemDiv.innerHTML = `
                    <div style="border: 1px solid var(--border); padding: 15px; border-radius: var(--radius); margin-bottom: 15px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" class="form-control contact-item-title" placeholder="Contact title">
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="text" class="form-control contact-item-number" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control contact-item-description" placeholder="Description"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Hours/Availability</label>
                            <input type="text" class="form-control contact-item-hours" placeholder="e.g., Available: 24/7">
                        </div>
                        <button type="button" class="btn btn-danger btn-sm remove-contact-item" style="margin-top: 10px;">
                            <i class="fas fa-trash"></i> Remove Item
                        </button>
                    </div>
                `;
                container.appendChild(itemDiv);
                
                // Add event listener to remove button
                itemDiv.querySelector('.remove-contact-item').addEventListener('click', () => {
                    itemDiv.remove();
                });
            }

            // Search methods
            searchQuickCall(query) {
                const tbody = document.getElementById('quickcall-table-body');
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                const searchText = query.trim().toLowerCase();
                
                if (searchText === '') {
                    rows.forEach(row => row.style.display = '');
                    return;
                }
                
                rows.forEach(row => {
                    const title = row.cells[1].textContent.toLowerCase();
                    const subtitle = row.cells[2].textContent.toLowerCase();
                    const number = row.cells[3].textContent.toLowerCase();
                    
                    if (title.includes(searchText) || subtitle.includes(searchText) || number.includes(searchText)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchContacts(query) {
                const preview = document.getElementById('contacts-accordion-preview');
                if (!preview) return;
                
                const accordions = preview.querySelectorAll('.accordion-preview');
                const searchText = query.trim().toLowerCase();
                
                if (searchText === '') {
                    accordions.forEach(acc => acc.style.display = '');
                    return;
                }
                
                accordions.forEach(accordion => {
                    const title = accordion.querySelector('.accordion-preview-header span').textContent.toLowerCase();
                    const content = accordion.querySelector('.accordion-preview-content').textContent.toLowerCase();
                    
                    if (title.includes(searchText) || content.includes(searchText)) {
                        accordion.style.display = '';
                    } else {
                        accordion.style.display = 'none';
                    }
                });
            }

            searchProcedures(query) {
                const tbody = document.getElementById('procedures-table-body');
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                const searchText = query.trim().toLowerCase();
                
                if (searchText === '') {
                    rows.forEach(row => row.style.display = '');
                    return;
                }
                
                rows.forEach(row => {
                    const title = row.cells[1].textContent.toLowerCase();
                    
                    if (title.includes(searchText)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchFacilities(query) {
                const tbody = document.getElementById('facilities-table-body');
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                const searchText = query.trim().toLowerCase();
                
                if (searchText === '') {
                    rows.forEach(row => row.style.display = '');
                    return;
                }
                
                rows.forEach(row => {
                    const name = row.cells[1].textContent.toLowerCase();
                    const address = row.cells[2].textContent.toLowerCase();
                    const type = row.cells[0].textContent.toLowerCase();
                    
                    if (name.includes(searchText) || address.includes(searchText) || type.includes(searchText)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchPreparation(query) {
                const preview = document.getElementById('preparation-checklist-preview');
                if (!preview) return;
                
                const categories = preview.querySelectorAll('.accordion-preview');
                const searchText = query.trim().toLowerCase();
                
                if (searchText === '') {
                    categories.forEach(cat => cat.style.display = '');
                    return;
                }
                
                categories.forEach(category => {
                    const title = category.querySelector('.accordion-preview-header span').textContent.toLowerCase();
                    const content = category.querySelector('.accordion-preview-content').textContent.toLowerCase();
                    
                    if (title.includes(searchText) || content.includes(searchText)) {
                        category.style.display = '';
                    } else {
                        category.style.display = 'none';
                    }
                });
            }

            exportData() {
                const dataStr = JSON.stringify(this.currentData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `emergency-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                this.logActivity('Emergency data exported successfully', 'success');
                this.showAlert('Emergency data exported successfully!', 'success');
            }

            clearAllData() {
                if (confirm('Clear ALL emergency data? This will remove everything and cannot be undone.')) {
                    localStorage.removeItem(this.dataKey);
                    this.currentData = this.getDefaultData();
                    this.populateForms();
                    this.saveData(true);
                    this.logActivity('All emergency data cleared', 'error');
                    this.showAlert('All emergency data has been cleared!', 'success');
                }
            }

            showAlert(message, type) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `<strong><i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i> ${message}</strong>`;
                
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab) {
                    currentTab.insertBefore(alert, currentTab.firstChild);
                }
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 5000);
            }

            logActivity(message, type) {
                const activity = {
                    timestamp: new Date().toLocaleTimeString(),
                    message: message,
                    type: type
                };
                this.activityLog.unshift(activity);
                
                if (this.activityLog.length > 10) {
                    this.activityLog.pop();
                }
                
                this.updateActivityLog();
            }

            updateActivityLog() {
                const container = document.getElementById('recent-activity');
                if (!container) return;

                if (this.activityLog.length === 0) {
                    container.innerHTML = `<p style="color: var(--gray); text-align: center; padding: 20px;"><i class="fas fa-clock"></i> No recent activity</p>`;
                    return;
                }

                container.innerHTML = this.activityLog.map(activity => `
                    <div style="padding: 10px 15px; border-left: 3px solid ${
                        activity.type === 'success' ? 'var(--success)' : 
                        activity.type === 'error' ? 'var(--error)' : 'var(--warning)'
                    }; margin-bottom: 10px; background: var(--gray-light); border-radius: 0 var(--radius) var(--radius) 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                            <span style="font-weight: 600;">${activity.message}</span>
                            <small style="color: var(--gray);">${activity.timestamp}</small>
                        </div>
                    </div>
                `).join('');
            }

            checkUserViewConnection() {
                console.log('Checking connection with emergency user view...');
                const userData = localStorage.getItem('emergencyContent');
                if (userData) {
                    console.log('Emergency user view data found');
                    this.showAlert('Connected to emergency user view successfully!', 'success');
                } else {
                    console.log('No emergency user view data found. Admin will create new data.');
                }
            }
        }

        // Initialize the emergency admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.emergencyAdminPanel = new EmergencyAdminPanel();
        });
    </script>
</body>
</html>